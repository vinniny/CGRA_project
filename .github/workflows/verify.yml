name: CGRA Verification

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  verilator-test:
    runs-on: ubuntu-latest
    container:
      image: verilator/verilator:v5.024
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Print Verilator version
      run: verilator --version
    
    - name: Build and Run CRV Test Suite
      run: |
        mkdir -p 03_sim
        make sim TOOL=verilator 2>&1 | tee 03_sim/test.log
    
    - name: Check for test failures
      run: |
        # Check if any FAIL lines exist (excluding expected failures)
        if grep -q "\[FAIL\]" 03_sim/test.log; then
          echo "❌ Some tests failed:"
          grep "\[FAIL\]" 03_sim/test.log
          exit 1
        fi
        
        # Check for assertion failures
        if grep -q "%Error" 03_sim/test.log; then
          echo "❌ Assertion failures detected:"
          grep "%Error" 03_sim/test.log
          exit 1
        fi
        
        echo "✅ All CRV tests passed"
    
    - name: Upload VCD waveform (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: waveform-vcd
        path: 03_sim/cgra_sim.vcd
        retention-days: 7
    
    - name: Upload simulation log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: simulation-log
        path: |
          03_sim/*.log
          03_sim/*.vcd
        retention-days: 7
